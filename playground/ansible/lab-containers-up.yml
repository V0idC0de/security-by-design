---
# yaml-language-server: $schema=https://raw.githubusercontent.com/ansible/ansible-lint/main/src/ansiblelint/schemas/ansible.json#/$defs/playbook
- name: (Re)create Lab Containers for specified users
  hosts: all
  become: true
  gather_facts: false

  vars_files:
    - vars/settings.yaml

  vars_prompt:
    - name: lab_dir
      prompt: "Enter the lab directory name (or part of it)"
      private: no

  vars:
    # "recreate" must be explicitly set with "-e recreate=true", as it's destructive.
    recreate: false
    lab_users: "{{ lab_users | default([], true) }}"

  tasks:
    - name: Gather Docker images info
      community.docker.docker_image_info:
      register: image_info

    - name: Filter images containing lab_dir (case-insensitive)
      ansible.builtin.set_fact:
        filtered_images: >-
          {{
            image_info.images 
            | map(attribute='RepoTags') 
            | flatten 
            | select('search', lab_dir) 
            | list
          }}

    - name: Fail if none or multiple images match
      ansible.builtin.fail:
        msg: |
          Expected exactly one image matching "{{ lab_dir }}", but found {{ filtered_images | length }}.
          Please refine your input.
      when: filtered_images | length != 1

    - name: Start Lab Containers
      ansible.builtin.include_role:
        name: lab-user-containers
      vars:
        container_users: "{{ lab_users }}"
        container_image: "{{ filtered_images | first }}"
        container_state: "started"
        recreate: "{{ recreate | bool }}"

    - name: Set SSH command for users
      ansible.builtin.include_role:
        name: sshd-lab-users
      vars:
        sshd_lab_user: "{{ item.key }}"
        sshd_container_name: "{{ item.value | split(':') | join('-') }}"
      loop: "{{ container_names | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
